name: "🎉 Velog → Jekyll Auto Sync"

on:
    workflow_dispatch:
    schedule:
        - cron: "0 */6 * * *" # 6시간마다 자동 실행

jobs:
    sync:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: pip install feedparser requests beautifulsoup4

            - name: Wait for Velog RSS to update
              run: sleep 180 # RSS 갱신 대기 (3분)

            - name: Run Velog sync script
              run: python velog_to_jekyll_images.py

            - name: Commit & Push changes
              run: |
                  git config user.name "Velog Sync Bot"
                  git config user.email "actions@github.com"
                  git add .
                  git commit -m "🪄 Auto-sync Velog posts" || echo "No changes"
                  git push

            - name: Send Discord notification
              if: success()
              env:
                  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  LATEST_POST=$(ls -t _posts | head -n 1)
                  MESSAGE="📰 새로운 포스트가 자동으로 업로드되었습니다!\n👉 $LATEST_POST"
                  curl -H "Content-Type: application/json" \
                       -d "{\"content\": \"$MESSAGE\"}" \
                       $DISCORD_WEBHOOK_URL
